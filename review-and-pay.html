<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>E-LegalBoom Review & Pay</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f7fb;
  margin:0;
  padding:0;
}

.container{
  max-width:500px;
  margin:60px auto;
  background:white;
  padding:30px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
}

h2{
  margin-top:0;
}

.summary{
  margin-bottom:25px;
  line-height:1.6;
}

button{
  width:100%;
  padding:14px;
  font-size:16px;
  background:#1e4ed8;
  color:white;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

button:hover{
  background:#153db0;
}
</style>

</head>
<body>

<div class="container">

<h2>Review Your Information</h2>

<div id="reviewBox" class="summary"></div>

<button id="payBtn">Proceed To Payment</button>

</div>


<script type="module">

/* ===============================
   SUPABASE CONNECTION (ONLY PLACE)
================================ */

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const SUPABASE_URL = "https://vvjbjfltqsivvxxifnvi.supabase.co"
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2amJqZmx0cXNpdnZ4eGlmbnZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYzNTAsImV4cCI6MjA3MzU1MjM1MH0.F4zzcpCHl9v-Rnj0wgKJ5zBf1HteVyXelMLQDDEN28Q"

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)



/* ===============================
   LOAD HANDSHAKE FROM INTAKE
================================ */

const intake = JSON.parse(sessionStorage.getItem("intakeData"))

if(!intake){
  alert("Missing intake data. Returning to intake.")
  window.location = "intake.html"
}



/* ===============================
   SAFE DISPLAY HELPERS
================================ */

const safe = (v) =>
  (v === undefined || v === null || v === "") ? "" : String(v)



/* ===============================
   DISPLAY REVIEW SUMMARY
================================ */

document.getElementById("reviewBox").innerHTML = `

<strong>Tier:</strong> ${safe(intake.tier)} <br>
<strong>Document:</strong> ${safe(intake.doc_type)} <br>
<strong>Price:</strong> $${safe(intake.price)} <br><br>

<strong>Customer</strong><br>
${safe(intake.client_first_name)} ${safe(intake.client_last_name)}<br>
${safe(intake.client_email)}<br>
${safe(intake.client_phone)}

`



/* ===============================
   TIER PAYMENT LINKS
   (YOU CONTROL PAYMENT BY TIER)
================================ */

function getPaymentLink(tier){

  const links = {

    "Tier 1 — Core Personal & Business":
    "https://pay.elegalboom.org/e4b79a60-0fd7-431c-8b1c-ae0",

    "Tier 2 — Business Formation & Operations":
    "https://pay.elegalboom.org/aeda586f-65f5-4bf0-9813-7a2",

    "Tier 3 — Employment, Real Estate & Advanced":
    "https://pay.elegalboom.org/71ca7144-e537-4fbd-823d-c10",

    "Tier 4 — Entrepreneur Bundle":
    "https://pay.elegalboom.org/55c7cd3d-1048-4b8c-aadb-843"

  }

  return links[tier]
}



/* ===============================
   PAYMENT BUTTON LOGIC
================================ */

document.getElementById("payBtn").onclick = async () => {

  const paymentLink = getPaymentLink(intake.tier)

  if(!paymentLink){
    alert("Payment link not found for selected tier.")
    return
  }

  /* ===== INSERT ORDER INTO DB ===== */

  const payload = {
    ...intake,
    order_status: "payment_pending",
    created_at: new Date().toISOString()
  }

  const { error } = await supabase
    .from("pweb_orders")
    .insert(payload)

  if(error){
    console.error(error)
    alert("Database error. Please retry.")
    return
  }

  /* ===== REDIRECT TO PAYMENT ===== */

  window.location = paymentLink

}

</script>

</body>
</html>
