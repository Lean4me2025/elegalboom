<!DOCTYPE html>
<html>
<head>
<title>Review & Pay</title>
</head>

<body>

<h2>Review Your Order</h2>
<div id="reviewBox"></div>

<button id="payBtn">Proceed To Payment</button>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase=createClient(
"https://vvjbjfltqsivvxxifnvi.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2amJqZmx0cXNpdnZ4eGlmbnZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYzNTAsImV4cCI6MjA3MzU1MjM1MH0.F4zzcpCHl9v-Rnj0wgKJ5zBf1HteVyXelMLQDDEN28Q"
);

const intake=JSON.parse(sessionStorage.getItem("intakeData"));

if(!intake){
alert("Missing intake data.");
window.location="intake.html";
}

document.getElementById("reviewBox").innerHTML=`
Tier: ${intake.tier}<br>
Document: ${intake.doc_type}<br>
Price: $${intake.price}<br><br>
${intake.client_first_name} ${intake.client_last_name}<br>
${intake.client_email}
`;

function generateOrderId(){
return "ELB-"+Date.now();
}

function paymentLinkByTier(tier){

const links={

"Tier 2 — Business Formation & Operations":
"https://pay.elegalboom.org/aeda586f-65f5-4bf0-9813-7a2",

"Tier 4 — Entrepreneur Bundle":
"https://pay.elegalboom.org/55c7cd3d-1048-4b8c-aadb-843"

};

return links[tier];
}

document.getElementById("payBtn").onclick=async()=>{

const paymentLink=paymentLinkByTier(intake.tier);

if(!paymentLink){
alert("Payment link missing.");
return;
}

const payload={
order_id:generateOrderId(),
...intake,
notes:intake.details || null,
order_status:"payment_pending",
created_at:new Date().toISOString()
};

delete payload.details;

const {error}=await supabase.from("pweb_orders").insert(payload);

if(error){
alert("Database insert failed.");
console.error(error);
return;
}

window.location=paymentLink;
};

</script>
</body>
</html>
