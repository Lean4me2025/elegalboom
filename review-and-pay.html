<!DOCTYPE html>
<html>
<head>
<title>Review & Pay</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>

<body>

<h2>Review Your Order</h2>

<div id="reviewBox"></div>

<br>
<button id="payBtn">Proceed To Payment</button>

<script type="module">

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

/* ===== INSERT YOUR SUPABASE KEYS ===== */

const supabase = createClient(
"YOUR_SUPABASE_URL",
"YOUR_SUPABASE_ANON_KEY"
);

/* ===== LOAD FINAL PAYLOAD ===== */

const intake = JSON.parse(sessionStorage.getItem("dataFlow"));

if(!intake){
   alert("Missing intake data. Returning to intake.");
   window.location = "intake.html";
}

/* ===== DISPLAY REVIEW ===== */

document.getElementById("reviewBox").innerHTML = `

<strong>Tier:</strong> ${intake.tier}<br>
<strong>Document:</strong> ${intake.doc_type}<br>
<strong>Price:</strong> $${intake.price}<br><br>

<strong>Client:</strong><br>
${intake.client_first_name} ${intake.client_last_name}<br>
${intake.client_email}<br>
${intake.client_phone}

`;

/* ===== PAYMENT LINKS BY TIER ===== */

function paymentLinkByTier(tier){

const links = {

"Tier 2 — Business Formation & Operations":
"https://pay.elegalboom.org/aeda586f-65f5-4bf0-9813-7a2",

"Tier 4 — Entrepreneur Bundle":
"https://pay.elegalboom.org/55c7cd3d-1048-4b8c-aadb-843"

};

return links[tier];

}

/* ===== PAYMENT BUTTON ===== */

document.getElementById("payBtn").onclick = async () => {

const paymentLink = paymentLinkByTier(intake.tier);

if(!paymentLink){
   alert("Payment link missing.");
   return;
}

/* ===== INSERT ORDER INTO DATABASE ===== */

const { error } = await supabase
   .from("pweb_orders")
   .insert({
      ...intake,
      created_at: new Date().toISOString()
   });

if(error){
   alert("Database insert failed.");
   console.error(error);
   return;
}

/* ===== REDIRECT TO PAYMENT ===== */

window.location = paymentLink;

};

</script>

</body>
</html>
