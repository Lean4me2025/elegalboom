<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>E-LegalBoom â€” Review & Pay</title>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* =============================
   ðŸ” SUPABASE CONFIG
   ============================= */

const SUPABASE_URL = "https://vvjbjfltqsivvxxifnvi.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2amJqZmx0cXNpdnZ4eGlmbnZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYzNTAsImV4cCI6MjA3MzU1MjM1MH0.F4zzcpCHl9v-Rnj0wgKJ5zBf1HteVyXelMLQDDEN28Q";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);


/* =============================
   ðŸ’³ PAYMENT LINKS BY TIER
   ============================= */

const PAYMENT_LINKS = {
  "Tier 1": "https://pay.elegalboom.org/e4b79a60-0fd7-431c-8bfc-0e0",
  "Tier 2": "https://pay.elegalboom.org/aed0586f-6515-4bf0-98f3-7a2",
  "Tier 3": "https://pay.elegalboom.org/71ca7144-e537-4fbd-823d-c10",
  "Tier 4": "https://pay.elegalboom.org/55c7cd3d-1048-4b8c-aadb-843"
};


/* =============================
   ðŸ“¦ LOAD SESSION DATA
   ============================= */

const selectedOrder = JSON.parse(sessionStorage.getItem("eLegal_selected_order") || "null");
const intakeData = JSON.parse(sessionStorage.getItem("intakeData") || "{}");

if (!selectedOrder || !selectedOrder.doc_type) {
  alert("Missing order selection");
  window.location.href = "catalog.html";
}


/* =============================
   ðŸ–¥ DISPLAY ORDER SUMMARY
   ============================= */

window.addEventListener("DOMContentLoaded", () => {

  document.getElementById("docType").innerText = selectedOrder.doc_type;
  document.getElementById("tier").innerText = selectedOrder.tier;
  document.getElementById("price").innerText = `$${selectedOrder.price}`;

});


/* =============================
   ðŸ§¾ CREATE ORDER + REDIRECT
   ============================= */

async function createOrder() {

  try {

    const insertPayload = {
      doc_type: selectedOrder.doc_type,
      tier: selectedOrder.tier,
      price: selectedOrder.price,

      client_first_name: intakeData.client_first_name || null,
      client_last_name: intakeData.client_last_name || null,
      client_email: intakeData.client_email || null,
      client_phone: intakeData.client_phone || null,

      client_street: intakeData.client_street || null,
      client_city: intakeData.client_city || null,
      client_state: intakeData.client_state || null,
      client_zip: intakeData.client_zip || null,

      governing_state: intakeData.governing_state || null,

      details: intakeData,
      order_status: "pending"
    };

    const { data, error } = await supabase
      .from("pweb_orders")
      .insert(insertPayload)
      .select()
      .single();

    if (error) throw error;

    /* Save Order ID for downstream fulfillment */
    sessionStorage.setItem("order_id", data.id);

    /* Redirect to payment */
    const payLink = PAYMENT_LINKS[selectedOrder.tier];
    window.location.href = payLink;

  }
  catch (err) {
    console.error(err);
    alert("Order creation failed");
  }

}

window.createOrder = createOrder;

</script>


<style>

body {
  font-family: Arial, sans-serif;
  background: #f5f7fa;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.card {
  background: white;
  padding: 40px;
  width: 420px;
  border-radius: 10px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.15);
  text-align: center;
}

h2 {
  margin-bottom: 30px;
}

.summary {
  background: #eef3ff;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 25px;
  text-align: left;
}

button {
  width: 100%;
  padding: 14px;
  border: none;
  background: #3b5bff;
  color: white;
  font-size: 16px;
  border-radius: 6px;
  cursor: pointer;
}

button:hover {
  background: #2746d8;
}

</style>

</head>


<body>

<div class="card">

  <h2>Review Your Order</h2>

  <div class="summary">
    <strong>Document:</strong> <span id="docType"></span><br/>
    <strong>Tier:</strong> <span id="tier"></span><br/>
    <strong>Price:</strong> <span id="price"></span>
  </div>

  <button onclick="createOrder()">Proceed To Payment</button>

</div>

</body>
</html>
