<!DOCTYPE html>
<html>
<head>
<title>Review & Pay</title>

<style>
body{
font-family:Arial;
background:#f4f7fb;
padding:40px;
}

.container{
max-width:700px;
margin:auto;
background:white;
padding:30px;
border-radius:10px;
box-shadow:0 2px 10px rgba(0,0,0,.1);
}

.review{
background:#eef2ff;
padding:20px;
border-radius:8px;
margin-bottom:20px;
}

button{
width:100%;
padding:14px;
background:#1d4ed8;
color:white;
border:none;
border-radius:6px;
font-size:18px;
cursor:pointer;
}
</style>
</head>


<body>

<div class="container">

<h2>Review Your Order</h2>

<div id="reviewBox" class="review"></div>

<button id="payBtn">Proceed To Payment</button>

</div>


<script type="module">

import { createClient }
from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";


/* --------------------
SUPABASE
--------------------- */

const supabase = createClient(
  "https://vvjbjfltqsivvxxifnvi.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2amJqZmx0cXNpdnZ4eGlmbnZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYzNTAsImV4cCI6MjA3MzU1MjM1MH0.F4zzcpCHl9v-Rnj0wgKJ5zBf1HteVyXelMLQDDEN28Q"
);


/* --------------------
CATALOG MASTER MAP
--------------------- */

const DOC_CATALOG = {

  PROMISSORY_NOTE:{ tier:"Tier 1", price:39 },
  NDA:{ tier:"Tier 1", price:39 },

  LLC_OPERATING:{ tier:"Tier 2", price:59 },

  EMPLOYMENT:{ tier:"Tier 3", price:99 },
  COMMERCIAL_LEASE:{ tier:"Tier 3", price:99 },

  ENTREPRENEUR_BUNDLE:{ tier:"Tier 4", price:149 }

};


/* --------------------
PAYMENT LINKS BY TIER
--------------------- */

const PAYMENT_LINKS = {
  "Tier 1":"TIER1_PAYMENT_LINK",
  "Tier 2":"TIER2_PAYMENT_LINK",
  "Tier 3":"TIER3_PAYMENT_LINK",
  "Tier 4":"TIER4_PAYMENT_LINK"
};


/* --------------------
LOAD SESSION DATA
--------------------- */

const selectedOrder =
JSON.parse(sessionStorage.getItem("elegal_selected_order"));

const intakeData =
JSON.parse(sessionStorage.getItem("intakeData")) || {};

if(!selectedOrder?.doc_type){
alert("Missing order selection");
window.location.href="catalog.html";
}


/* --------------------
DERIVE PRODUCT DATA
--------------------- */

const product =
DOC_CATALOG[selectedOrder.doc_type];

const tier = product.tier;
const price = product.price;


/* --------------------
DISPLAY ORDER
--------------------- */

document.getElementById("reviewBox").innerHTML = `
Document: ${selectedOrder.doc_type}<br>
Tier: ${tier}<br>
Price: $${price}
`;


/* --------------------
ORDER ID GENERATOR
--------------------- */

function generateOrderId(){
return "ELB-" + Date.now();
}


/* --------------------
PAYMENT CLICK
--------------------- */

document.getElementById("payBtn").onclick = async ()=>{

const orderId = generateOrderId();

const payload = {

order_id: orderId,
doc_type: selectedOrder.doc_type,
tier: tier,
price: price,
intake_json: intakeData,
order_status:"payment_pending",
created_at: new Date().toISOString()

};


/* -------- DB INSERT -------- */

const { error } = await supabase
.from("pweb_orders")
.insert(payload);

if(error){
alert("Order creation failed");
console.error(error);
return;
}


/* -------- REDIRECT PAYMENT -------- */

window.location.href = PAYMENT_LINKS[tier];

};

</script>

</body>
</html>
