<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>E-LegalBoom â€” Review & Pay</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:system-ui;
  background:#f6f8fb;
  padding:30px;
}

.card{
  background:white;
  padding:25px;
  border-radius:14px;
  max-width:700px;
  margin:auto;
  box-shadow:0 10px 30px rgba(0,0,0,.05);
}

h1{margin-top:0}

.row{
  margin-bottom:12px;
  font-size:16px;
}

button{
  width:100%;
  padding:16px;
  font-size:18px;
  background:#1a4cff;
  color:white;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="card">
<h1>Review & Pay</h1>

<div class="row"><strong>Order ID:</strong> <span id="orderID"></span></div>
<div class="row"><strong>Document:</strong> <span id="docType"></span></div>
<div class="row"><strong>Tier:</strong> <span id="tier"></span></div>
<div class="row"><strong>Price:</strong> $<span id="price"></span></div>
<div class="row"><strong>Email:</strong> <span id="email"></span></div>

<br>
<button id="payBtn">Proceed To Payment</button>

</div>

<script>

// ---------------- SUPABASE INIT ----------------
const supabase = window.supabase.createClient(
  "https://vvjbjfltqsivvxxifnvi.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2amJqZmx0cXNpdnZ4eGlmbnZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYzNTAsImV4cCI6MjA3MzU1MjM1MH0.F4zzcpCHl9v-Rnj0wgKJ5zBf1HteVyXelMLQDDEN28Q"
);

// ---------------- LOAD INTAKE PAYLOAD ----------------
const payload = JSON.parse(sessionStorage.getItem("elegal_intake_data"));

if(!payload){
  alert("Missing intake data");
  window.location.href="catalog.html";
}

// ---------------- ENSURE ORDER ID ----------------
if(!payload.order_id){
  payload.order_id = "ELB-" + Date.now();
  sessionStorage.setItem("elegal_intake_data", JSON.stringify(payload));
}

// ---------------- DERIVE COMMERCE FIELDS ----------------
const docType = payload.doc_type || payload.doc_types?.[0];

const DOC_MAP = {
  NDA:{tier:"Tier 1",price:39,pay:"PAY_LINK_T1"},
  PROMISSORY_NOTE:{tier:"Tier 1",price:39,pay:"PAY_LINK_T1"},
  BILL_OF_SALE:{tier:"Tier 1",price:39,pay:"PAY_LINK_T1"},

  PARTNERSHIP:{tier:"Tier 2",price:59,pay:"PAY_LINK_T2"},
  LLC_OPERATING:{tier:"Tier 2",price:59,pay:"PAY_LINK_T2"},

  SERVICE_AGREEMENT:{tier:"Tier 3",price:99,pay:"PAY_LINK_T3"},
  EMPLOYMENT:{tier:"Tier 3",price:99,pay:"PAY_LINK_T3"},
  COMMERCIAL_LEASE:{tier:"Tier 3",price:99,pay:"PAY_LINK_T3"},

  ENTREPRENEUR_BUNDLE:{tier:"Tier 4",price:149,pay:"PAY_LINK_T4"}
};

if(!payload.tier || !payload.price){
  const map = DOC_MAP[docType];
  if(map){
    payload.tier = map.tier;
    payload.price = map.price;
  }
}

// ---------------- DISPLAY ----------------
document.getElementById("orderID").textContent = payload.order_id;
document.getElementById("docType").textContent = docType;
document.getElementById("tier").textContent = payload.tier;
document.getElementById("price").textContent = payload.price;
document.getElementById("email").textContent = payload.client_email;


// ---------------- INSERT ORDER (TRANSFER STEP) ----------------
async function transferOrder(){

  const record = {
    order_id: payload.order_id,
    doc_type: docType,
    tier: payload.tier,
    price: payload.price,
    client_email: payload.client_email,
    intake_json: payload,
    order_status:"CREATED",
    created_at:new Date().toISOString()
  };

  const {error} = await supabase
    .from("pweb_orders")
    .insert(record);

  if(error){
    console.error(error);
    alert("Order creation failed");
    return false;
  }

  return true;
}


// ---------------- PAYMENT ROUTING ----------------
document.getElementById("payBtn").onclick = async () => {

  const ok = await transferOrder();
  if(!ok) return;

  const payLink = DOC_MAP[docType]?.pay;

  if(!payLink){
    alert("Missing pay link");
    return;
  }

  window.location.href = payLink;

};

</script>
</body>
</html>
