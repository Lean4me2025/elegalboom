<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Review & Pay</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f7fb;
  padding: 40px;
}

.container {
  max-width: 700px;
  margin: auto;
  background: white;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.card {
  background: #eef2ff;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}

h1 {
  text-align: center;
}

.btn {
  width: 100%;
  padding: 14px;
  background: #4f46e5;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
}

.btn:hover {
  background: #4338ca;
}
</style>
</head>

<body>

<div class="container">

<h1>Review & Pay</h1>

<div class="card">
  <p><strong>Document:</strong> <span id="docDisplay"></span></p>
  <p><strong>Tier:</strong> <span id="tierDisplay"></span></p>
  <p><strong>Price:</strong> $<span id="priceDisplay"></span></p>
</div>

<div class="card">
  <p><strong>Name:</strong> <span id="nameDisplay"></span></p>
  <p><strong>Email:</strong> <span id="emailDisplay"></span></p>
  <p><strong>Phone:</strong> <span id="phoneDisplay"></span></p>
</div>

<button class="btn" id="payBtn">Proceed To Payment</button>

</div>

<script>

/* ================= SUPABASE CONFIG ================= */

const SUPABASE_URL = "https://vvjbjfltqsivvxxifnvi.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2amJqZmx0cXNpdnZ4eGlmbnZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYzNTAsImV4cCI6MjA3MzU1MjM1MH0.F4zzcpCHl9v-Rnj0wgKJ5zBf1HteVyXelMLQDDEN28Q";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


/* ================= GODADDY PAY LINKS ================= */

const PAY_LINKS = {

  "Tier 1": "https://pay.elegalboom.org/e4b79a60-0fd7-431c-8bfc-ae0",
  "tier1": "https://pay.elegalboom.org/e4b79a60-0fd7-431c-8bfc-ae0",

  "Tier 2": "https://pay.elegalboom.org/eeda586f-65f5-4bf0-98f3-7a2",
  "tier2": "https://pay.elegalboom.org/eeda586f-65f5-4bf0-98f3-7a2",

  "Tier 3": "https://pay.elegalboom.org/71ca7144-e537-4fbd-823d-c10",
  "tier3": "https://pay.elegalboom.org/71ca7144-e537-4fbd-823d-c10",

  "Tier 4": "https://pay.elegalboom.org/55c7cd3d-1048-4b8c-aadb-843",
  "tier4": "https://pay.elegalboom.org/55c7cd3d-1048-4b8c-aadb-843"

};


/* ================= LOAD SESSION ================= */

const payload = JSON.parse(sessionStorage.getItem("elegal_intake_data"));

if (!payload) {
  alert("Missing intake data.");
  window.location.href = "catalog.html";
}


/* ================= DISPLAY ================= */

document.getElementById("docDisplay").textContent = payload.doc_type;
document.getElementById("tierDisplay").textContent = payload.tier;
document.getElementById("priceDisplay").textContent = payload.price;

document.getElementById("nameDisplay").textContent =
  payload.client_first_name + " " + payload.client_last_name;

document.getElementById("emailDisplay").textContent = payload.client_email;
document.getElementById("phoneDisplay").textContent = payload.client_phone;


/* ================= PAYMENT CLICK ================= */

document.getElementById("payBtn").addEventListener("click", async () => {

  console.log("Creating order...");

  /* Guarantee Order ID */
  if (!payload.order_id) {
    payload.order_id = "ELB-" + Date.now();
  }

  /* Insert Order */
  const { data, error } = await supabaseClient
    .from("pweb_orders")
    .insert({

      order_id: payload.order_id,
      doc_type: payload.doc_type,
      tier: order.tier,
      price: order.price,

      client_first_name: payload.client_first_name,
      client_last_name: payload.client_last_name,
      client_email: payload.client_email,
      client_phone: payload.client_phone,

      order_notes: payload.order_notes || null,
      intake_json: payload,

      order_status: "pending_payment"

    })
    .select()
    .single();

  if (error) {
    console.error(error);
    alert("Order creation failed.");
    return;
  }

  console.log("Order Created:", data.order_id);

  /* Redirect To Payment */
  const payLink = PAY_LINKS[payload.tier];

  if (!payLink) {
    alert("Missing payment link.");
    return;
  }

  window.location.href = payLink;

});

</script>

</body>
</html>
