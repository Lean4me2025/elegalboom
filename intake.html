<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Client Intake â€“ Step 1 | E-LegalBoom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="style.css"/>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6f8fb;
      color: #0f172a;
    }

    .page {
      max-width: 960px;
      margin: 28px auto 48px;
      padding: 0 18px;
    }

    h1 {
      font-size: 1.9rem;
      margin-bottom: 6px;
      color: #0b7285;
    }

    .subtitle {
      font-size: 0.98rem;
      color: #475569;
      max-width: 780px;
      line-height: 1.5;
    }

    .summary {
      margin-top: 14px;
      padding: 12px 14px;
      background: #eff6ff;
      border-left: 4px solid #2563eb;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #1e293b;
    }

    .summary strong {
      color: #1d4ed8;
    }

    form {
      margin-top: 18px;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      padding: 18px 16px 20px;
      box-shadow: 0 10px 24px rgba(15,23,42,0.06);
    }

    .section {
      margin-top: 18px;
      border-top: 1px solid #e5e7eb;
      padding-top: 12px;
    }

    .section h2 {
      font-size: 1.05rem;
      margin: 0 0 8px;
      color: #0f172a;
    }

    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: #111827;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    textarea,
    select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .hint {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: -4px;
      margin-bottom: 6px;
    }

    .required-mark {
      color: #dc2626;
      margin-left: 2px;
    }

    .btn-row {
      margin-top: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-end;
    }

    button[type="submit"] {
      background: #0b7285;
      color: #ffffff;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(11,114,133,0.35);
    }

    button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: progress;
      box-shadow: none;
    }

    .secondary-btn {
      background: transparent;
      border-radius: 999px;
      border: 1px solid #0b7285;
      color: #0b7285;
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .status {
      margin-top: 12px;
      font-size: 0.9rem;
    }

    .status.error {
      color: #b91c1c;
    }

    .status.success {
      color: #166534;
    }

    @media (max-width: 640px) {
      .page {
        margin: 18px auto 32px;
        padding: 0 14px;
      }
      form {
        padding: 14px 12px 16px;
      }
    }
  </style>
</head>

<body>

<section class="page">
  <h1>Client Intake â€“ Step 1</h1>
  <p class="subtitle">
    This step opens your E-LegalBoom file and assigns your order to the correct tier.
    Youâ€™ll enter basic information here, complete payment next, and then provide detailed document
    information in Step 3.
  </p>

  <div class="summary">
    Tier selected: <strong><span id="tierLabel">(not set)</span></strong><br/>
    Pricing: <strong><span id="tierPrice">(per document)</span></strong><br/>
    Note: <span id="tierNote">Each order covers one document. Additional documents require additional orders unless using the Entrepreneur Starter Bundle.</span>
  </div>

  <form id="intakeForm">
    <!-- Hidden fields -->
    <input type="hidden" id="tierCode" name="tierCode" value="">
    <input type="hidden" id="stage" name="stage" value="intake1">

    <!-- SECTION 1 â€“ Contact & basic info -->
    <div class="section">
      <h2>Your Information</h2>

      <label for="fullName">Full name<span class="required-mark">*</span></label>
      <input type="text" id="fullName" name="fullName" required>

      <label for="email">Email address<span class="required-mark">*</span></label>
      <input type="email" id="email" name="email" required>

      <label for="phone">Phone number (optional)</label>
      <input type="tel" id="phone" name="phone">

      <label for="state">State where your business operates or will be formed<span class="required-mark">*</span></label>
      <input type="text" id="state" name="state" required>
      <div class="hint">Example: CA, TX, FL, or full state name. This helps us apply the correct rules.</div>

      <label for="businessName">Business / Entity name (if any)</label>
      <input type="text" id="businessName" name="businessName">

      <label for="businessDescription">What does your business do?</label>
      <textarea id="businessDescription" name="businessDescription"
                placeholder="Example: Online coaching and consulting for small businesses."></textarea>
    </div>

    <!-- SECTION 2 â€“ Document focus (per-document model) -->
    <div class="section">
      <h2>Document for This Order</h2>

      <label for="docType">Which document are you purchasing with this order?<span class="required-mark">*</span></label>
      <select id="docType" name="docType" required>
        <option value="">Select a documentâ€¦</option>
        <option value="NDA">Mutual NDA</option>
        <option value="PROMISSORY_NOTE">Promissory Note</option>
        <option value="SINGLE_MEMBER_LLC">Single-Member LLC Operating Agreement</option>
        <option value="PARTNERSHIP">Partnership Agreement</option>
        <option value="TWO_MEMBER_LLC">Two-Member LLC Agreement</option>
        <option value="BUY_SELL">Buyâ€“Sell / Investor Agreement</option>
        <option value="SERVICE">Service / Independent Contractor Agreement</option>
        <option value="CONSULTING">Business Consulting / Services Agreement</option>
        <option value="JV">Joint Venture / Founder Arrangement</option>
        <option value="OTHER">Other / Custom Document</option>
      </select>
      <div class="hint" id="docHint">
        You are purchasing one document with this order. If you need more than one document,
        you can place additional orders or consider the Entrepreneur Starter Bundle.
      </div>

      <label for="primaryGoal">In 1â€“3 sentences, what do you want this document to accomplish?<span class="required-mark">*</span></label>
      <textarea id="primaryGoal" name="primaryGoal" required
                placeholder="Example: I am loaning $5,000 to a family member and want clear repayment terms in writing."></textarea>
    </div>

    <!-- SECTION 3 â€“ Confirmation -->
    <div class="section">
      <h2>Confirm & Continue</h2>
      <p style="font-size:0.88rem;color:#4b5563;">
        After you submit this form, youâ€™ll be directed to secure payment for the selected tier.
        Once payment is complete, you will receive a link to Step 3 to provide detailed information
        for this specific document.
      </p>
    </div>

    <div class="btn-row">
      <button type="submit">Submit & Go to Payment â†’</button>
      <button type="button" class="secondary-btn" onclick="window.location.href='catalog.html'">
        Back to Catalog
      </button>
    </div>

    <div class="status" id="statusMessage"></div>
  </form>
</section>

<script>
  // ðŸ’¡ Use your existing deployed Apps Script web app URL
  const SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbxirMiGTQQmUGLUxCcuSX1_qasnfRxBL1ycs08z-LTmF9CxgHeivGrVqGi2D_MuRpt/exec";

  function getParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  function mapTierLabel(code) {
    const c = (code || "").toUpperCase();
    if (c === "T1") return "Tier 1 â€“ Startup & Essential Documents";
    if (c === "T2") return "Tier 2 â€“ Business Foundation Documents";
    if (c === "T3") return "Tier 3 â€“ Premium Business Agreements";
    if (c === "ENT") return "Entrepreneur Starter Bundle";
    return "No tier selected";
  }

  function mapTierPrice(code) {
    const c = (code || "").toUpperCase();
    if (c === "T1") return "$39 per document";
    if (c === "T2") return "$59 per document";
    if (c === "T3") return "$99 per document";
    if (c === "ENT") return "$149 flat â€¢ multiple documents within 30-day window";
    return "(per document)";
  }

  function mapTierNote(code) {
    const c = (code || "").toUpperCase();
    if (c === "ENT") {
      return "The Entrepreneur Starter Bundle provides access to multiple documents within a 30-day window. " +
             "Youâ€™ll submit one intake per document during that period.";
    }
    return "Each order covers one document. If you need additional documents, place additional orders or consider the Entrepreneur Starter Bundle.";
  }

  function adjustDocHintForTier(code) {
    const c = (code || "").toUpperCase();
    const docHint = document.getElementById("docHint");
    if (!docHint) return;

    if (c === "ENT") {
      docHint.textContent =
        "With the Entrepreneur Starter Bundle, youâ€™ll be able to submit multiple document requests during your 30-day window. " +
        "This intake applies to one document; you can submit more after this one is processed.";
    } else {
      docHint.textContent =
        "You are purchasing one document with this order. If you need more than one document, " +
        "you can place additional orders or consider the Entrepreneur Starter Bundle.";
    }
  }

  async function tryPrefill(prefillId) {
    if (!prefillId) return;
    try {
      const url = `${SCRIPT_URL}?mode=prefill&intakeId=${encodeURIComponent(prefillId)}`;
      const resp = await fetch(url);
      const json = await resp.json();
      if (!json.success || !json.intake) return;

      const i = json.intake;
      if (i.fullName) document.getElementById("fullName").value = i.fullName;
      if (i.email) document.getElementById("email").value = i.email;
      if (i.phone) document.getElementById("phone").value = i.phone;
      if (i.state) document.getElementById("state").value = i.state;
      if (i.businessName) document.getElementById("businessName").value = i.businessName;
      if (i.businessDescription) document.getElementById("businessDescription").value = i.businessDescription;
    } catch (err) {
      console.error("Prefill error:", err);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const tierCode = getParam("tier") || "";
    const prefillId = getParam("prefillId") || "";

    document.getElementById("tierCode").value = tierCode;
    document.getElementById("tierLabel").textContent = mapTierLabel(tierCode);
    document.getElementById("tierPrice").textContent = mapTierPrice(tierCode);
    document.getElementById("tierNote").textContent = mapTierNote(tierCode);
    adjustDocHintForTier(tierCode);

    // ðŸ”„ Prefill if coming back with prefillId (one-click reorder)
    if (prefillId) {
      tryPrefill(prefillId);
    }

    const form = document.getElementById("intakeForm");
    const statusEl = document.getElementById("statusMessage");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusEl.textContent = "";
      statusEl.className = "status";

      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = "Submittingâ€¦";

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      try {
        const resp = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const json = await resp.json();

        if (!json.success) {
          throw new Error(json.error || "Unknown error");
        }

        const tier = tierCode || "";
        const intakeId = json.intakeId || "";
        let nextUrl = "orders.html";
        const params = new URLSearchParams();
        if (tier) params.set("tier", tier);
        if (intakeId) params.set("intakeId", intakeId);
        if (data.docType) params.set("docType", data.docType);

        if ([...params.keys()].length > 0) {
          nextUrl += "?" + params.toString();
        }

        statusEl.textContent = "Intake saved. Redirecting to paymentâ€¦";
        statusEl.classList.add("success");

        window.location.href = nextUrl;

      } catch (err) {
        console.error(err);
        statusEl.textContent =
          "There was a problem saving your intake. Please try again or contact us if this continues.";
        statusEl.classList.add("error");
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit & Go to Payment â†’";
      }
    });
  });
</script>

</body>
</html>
