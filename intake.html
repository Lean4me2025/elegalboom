<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GetPass Intake</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>

  <h1>GetPass Intake</h1>

  <form id="intake-form">

    <!-- BASIC REQUIRED FIELDS -->
    <label>
      First Name *
      <input type="text" id="first_name" required />
    </label>

    <label>
      Last Name *
      <input type="text" id="last_name" required />
    </label>

    <label>
      Email *
      <input type="email" id="email" required />
    </label>

    <!-- OPTIONAL / PASSIVE FIELDS -->
    <label>
      Phone
      <input type="text" id="phone" />
    </label>

    <label>
      Tier
      <select id="tier">
        <option value="">â€”</option>
        <option value="1">Tier 1</option>
        <option value="2">Tier 2</option>
        <option value="3">Tier 3</option>
        <option value="4">Tier 4</option>
      </select>
    </label>

    <label>
      Document Type
      <input type="text" id="doc_type" />
    </label>

    <button type="submit">Continue</button>
  </form>

  <!-- ============================= -->
  <!-- INLINE SUBMIT + DB LOGIC ONLY -->
  <!-- ============================= -->
  <script>
    // ===== SUPABASE CONFIG =====
    const SUPABASE_URL = "https://vvjbjfltqsivvxxifnvi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2amJqZmx0cXNpdnZ4eGlmbnZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYzNTAsImV4cCI6MjA3MzU1MjM1MH0.F4zzcpCHl9v-Rnj0wgKJ5zBf1HteVyXelMLQDDEN28Q";

    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    const form = document.getElementById("intake-form");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      // Generate order_id
      const order_id = "ELB-" + Date.now();

      // Collect values
      const payload = {
        order_id: order_id,
        client_first_name: document.getElementById("first_name").value.trim(),
        client_last_name: document.getElementById("last_name").value.trim(),
        client_email: document.getElementById("email").value.trim(),
        client_phone: document.getElementById("phone").value.trim() || null,
        tier: document.getElementById("tier").value || null,
        doc_type: document.getElementById("doc_type").value || null,
        order_status: "initiated"
      };

      // Minimal required validation
      if (!payload.client_first_name || !payload.client_last_name || !payload.client_email) {
        alert("Please complete required fields.");
        return;
      }

      // Insert ONE row
      const { error } = await supabase
        .from("pweb_orders")
        .insert([payload]);

      if (error) {
        console.error(error);
        alert("Error submitting intake.");
        return;
      }

      // Redirect
      window.location.href =
        "review-and-pay.html?order_id=" + order_id;
    });
  </script>

</body>
</html>
