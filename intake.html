<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>E-LegalBoom – Intake</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f7f9;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 760px;
      margin: 40px auto;
      background: #ffffff;
      padding: 32px;
      border-radius: 8px;
    }
    h1 {
      margin-top: 0;
    }
    label {
      display: block;
      margin-top: 18px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      box-sizing: border-box;
    }
    button {
      margin-top: 28px;
      padding: 14px 24px;
      font-size: 16px;
      background: #0a5cff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background: #999;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Document Intake</h1>

    <form id="intakeForm">

      <!-- Hidden / Context Fields -->
      <input type="hidden" id="order_id" />
      <input type="hidden" id="document_type" />
      <input type="hidden" id="tier" />

      <label>First Name</label>
      <input type="text" id="first_name" required />

      <label>Last Name</label>
      <input type="text" id="last_name" required />

      <label>Email</label>
      <input type="email" id="email" required />

      <label>Phone</label>
      <input type="text" id="phone" />

      <label>Business / Entity Name</label>
      <input type="text" id="business_name" />

      <label>Street Address</label>
      <input type="text" id="street" />

      <label>City</label>
      <input type="text" id="city" />

      <label>State of Residence</label>
      <input type="text" id="state" />

      <label>ZIP Code</label>
      <input type="text" id="zip" />

      <label>Governing State (for document)</label>
      <input type="text" id="governing_state" />

      <label>Additional Details</label>
      <textarea id="details" rows="4"></textarea>

      <button type="submit" id="submitBtn">Submit Intake</button>
    </form>
  </div>

  <script>
    /*************************************************
     * Supabase Client (SINGLE, NON-SHADOWING)
     *************************************************/
    const SUPABASE_URL = https://vvjbjfltqsivvxxifnvi.supabase.co;
    const SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2amJqZmx0cXNpdnZ4eGlmbnZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYzNTAsImV4cCI6MjA3MzU1MjM1MH0.F4zzcpCHl9v-Rnj0wgKJ5zBf1HteVyXelMLQDDEN28Q;

    const supabaseClient = supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    /*************************************************
     * Helpers
     *************************************************/
    function generateOrderId() {
      return "ORD-" + Date.now() + "-" + Math.floor(Math.random() * 100000);
    }

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    /*************************************************
     * Initialize Context
     *************************************************/
    const orderId = generateOrderId();
    const documentType = getQueryParam("document") || "";
    const tier = getQueryParam("tier") || "";

    document.getElementById("order_id").value = orderId;
    document.getElementById("document_type").value = documentType;
    document.getElementById("tier").value = tier;

    // Persist for payment page
    localStorage.setItem("order_id", orderId);
    localStorage.setItem("document_type", documentType);
    localStorage.setItem("tier", tier);

    /*************************************************
     * Submit Handler
     *************************************************/
    document.getElementById("intakeForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;

      const payload = {
        order_id: orderId,
        document_type: documentType,
        tier: tier,
        first_name: document.getElementById("first_name").value,
        last_name: document.getElementById("last_name").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        business_name: document.getElementById("business_name").value,
        street: document.getElementById("street").value,
        city: document.getElementById("city").value,
        state: document.getElementById("state").value,
        zip: document.getElementById("zip").value,
        governing_state: document.getElementById("governing_state").value,
        details: document.getElementById("details").value
      };

      const { error } = await supabaseClient
        .from("requests")
        .insert([payload]);

      if (error) {
        console.error("Supabase insert error:", error);
        alert("There was an error submitting your intake. Please try again.");
        submitBtn.disabled = false;
        return;
      }

      // SUCCESS → redirect
      window.location.href = "payment.html";
    });
  </script>
</body>
</html>
