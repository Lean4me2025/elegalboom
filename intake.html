
// intake.js
// Authoritative intake submit logic
// Creates full pweb_orders record and redirects to review-and-pay.html

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// üîê Supabase configuration (use your existing working values)
const SUPABASE_URL = "https://vvjbjfltqsivvxxifnvi.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2amJqZmx0cXNpdnZ4eGlmbnZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYzNTAsImV4cCI6MjA3MzU1MjM1MH0.F4zzcpCHl9v-Rnj0wgKJ5zBf1HteVyXelMLQDDEN28Q";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("intake-form");

  if (!form) {
    console.error("Intake form not found");
    return;
  }

  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    // üîë Generate authoritative order ID
    const order_id = `ELB-${crypto.randomUUID().toUpperCase()}`;

    // üì• Collect mapped intake fields (NO transformation)
    const payload = {
      order_id,
      client_first_name: document.getElementById("first_name")?.value.trim() || null,
      client_last_name: document.getElementById("last_name")?.value.trim() || null,
      client_email: document.getElementById("email")?.value.trim() || null,
      client_phone: document.getElementById("phone")?.value.trim() || null,
      client_business_name: document.getElementById("business_name")?.value.trim() || null,
      client_state: document.getElementById("client_state")?.value || null,
      governing_state: document.getElementById("governing_state")?.value || null,
      doc_type: document.getElementById("doc_type")?.value || null,
      tier: document.getElementById("tier")?.value || null,
      file_option: document.getElementById("file_option")?.value || null,
      details: document.getElementById("details")?.value.trim() || null,
      order_status: "initiated"
    };

    // üõë Required-field guard (per mapping)
    if (
      !payload.client_first_name ||
      !payload.client_last_name ||
      !payload.client_email ||
      !payload.doc_type
    ) {
      alert("Please complete all required fields before continuing.");
      return;
    }

    // üì¶ Insert full web order
    const { error } = await supabase
      .from("pweb_orders")
      .insert([payload]);

    if (error) {
      console.error("Order insert failed:", error);
      alert("There was an error submitting your order. Please try again.");
      return;
    }

    // ‚û°Ô∏è Redirect to existing review page
    window.location.href = `/review-and-pay.html?order_id=${order_id}`;
  });
});
