<script>
/************************************************************
 * 1. LOAD ORDER CONTEXT (FROM SUMMARY)
 ************************************************************/
const orderPayloadRaw = sessionStorage.getItem("orderPayload");

if (!orderPayloadRaw) {
  alert("Missing order context. Please start again.");
  window.location.href = "catalog.html";
}

const orderPayload = JSON.parse(orderPayloadRaw);

if (!orderPayload || !orderPayload.doc_type) {
  alert("Missing order context. Please start again.");
  window.location.href = "catalog.html";
}

/************************************************************
 * 2. HANDLE INTAKE SUBMIT
 ************************************************************/
document
  .getElementById("intakeForm")
  .addEventListener("submit", async (e) => {
    e.preventDefault();

    /* ----------------------------------
       Collect form values
    ---------------------------------- */
    const fullName = document.getElementById("full_name").value.trim();
    const email = document.getElementById("email").value.trim();
    const details = document.getElementById("details").value.trim();
    const urgency = document.getElementById("urgency").value;
    const fileOption = document.getElementById("file_option").value;

    if (!fullName || !email) {
      alert("Name and email are required.");
      return;
    }

    /* ----------------------------------
       Split name safely
    ---------------------------------- */
    const nameParts = fullName.split(" ");
    const firstName = nameParts.shift() || null;
    const lastName = nameParts.join(" ") || null;

    /********************************************************
     * 3. CANONICAL INTAKE RECORD
     *    (MATCHES pub_orders STRUCTURE)
     ********************************************************/
    const intakeRecord = {
      request_uuid: crypto.randomUUID(),
      client_first_name: firstName,
      client_last_name: lastName,
      client_email: email,
      doc_type: orderPayload.doc_type,
      governing_state: null,
      urgency: urgency,
      details: details,
      file_option: fileOption,
      tier: orderPayload.tier,
      amount: orderPayload.amount,
      order_status: "intake_completed"
    };

    /* ----------------------------------
       Persist for next step
    ---------------------------------- */
    sessionStorage.setItem(
      "intakeRecord",
      JSON.stringify(intakeRecord)
    );

    /* ----------------------------------
       Advance flow
    ---------------------------------- */
    window.location.href = "payment.html";
  });
</script>
