// Tell Vercel to use Node.js (not Edge)
export const config = {
  runtime: "nodejs",
};

import fs from "fs";
import path from "path";
import PizZip from "pizzip";
import Docxtemplater from "docxtemplater";
import { createClient } from "@supabase/supabase-js";

// Initialize Supabase (server-side, secure)
const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

export default async function handler(req, res) {
  try {
    // 1️⃣ Read input
    const { order_id } = req.query;

    if (!order_id) {
      return res.status(400).json({ error: "Missing order_id" });
    }

    // 2️⃣ Fetch the order
    const { data: order, error: fetchError } = await supabase
      .from("document_requests")
      .select("*")
      .eq("order_id", order_id)
      .single();

    if (fetchError || !order) {
      return res.status(404).json({ error: "Order not found" });
    }

    // 3️⃣ Safety check
    if (order.order_status !== "pending") {
      return res.status(200).json({
        message: "Order is not pending; document not created",
        current_status: order.order_status,
      });
    }

    // 4️⃣ Load the DOCX template
    const templatePath = path.resolve(
      process.cwd(),
      "templates",
      "operating-agreement.docx"
    );

    if (!fs.existsSync(templatePath)) {
      return res.status(500).json({ error: "Template file not found" });
    }

    const content = fs.readFileSync(templatePath, "binary");
    const zip = new PizZip(content);

    const doc = new Docxtemplater(zip, {
      paragraphLoop: true,
      linebreaks: true,
    });

    // 5️⃣ Inject data into the template
    doc.setData({
      company_name: order.company_name,
      state: order.governing_state,
      effective_date: new Date().toLocaleDateString(),

      member_1_name: order.member_1_name,
      member_1_percent: order.member_1_percent,

      member_2_name: order.member_2_name,
      member_2_percent: order.member_2_percent,

      member_3_name: order.member_3_name,
      member_3_percent: order.member_3_percent,

      member_4_name: order.member_4_name,
      member_4_percent: order.member_4_percent,

      member_5_name: order.member_5_name,
      member_5_percent: order.member_5_percent,
    });

    doc.render();

    // 6️⃣ Generate the DOCX file
    const buffer = doc.getZip().generate({
      type: "nodebuffer",
      compression: "DEFLATE",
    });

    // 7️⃣ EXPLICITLY tell the browser what this is
    res.setHeader(
      "Content-Type",
      "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    );

    res.setHeader(
      "Content-Disposition",
      `attachment; filename="Operating_Agreement_${order_id}.docx"`
    );

    // 8️⃣ Send the file
    return res.status(200).send(buffer);

  } catch (err) {
    console.error("Document generation error:", err);
    return res.status(500).json({ error: "Internal server error" });
  }
}
